{"data":{"css":"","data":[],"name":"network","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\n//me.list = [];\nme.all = {};\nme.viewer = $(ME).data('scene').viewer;\n\nme.ready = function(){\n  me.center = new THREE.Vector3(-60,-20,-60);\n  me.recenter = new THREE.Vector3(0,0,0);\n  me.camv = new THREE.Vector3(0,0,0);\n  me.distance = 10;\n  me.redistance = 10;\n  me.olddistance = 10;\n  me.now = new Date().getTime()\n  me.refresh();\n  WSCB = function(data){\n    add(data.data);\n  };\n};\n\nme.refresh = function(){\n  if ($(document.body).find(me.UUID == ME)){\n    json('../peerbot/connections', null, function(result){\n      if (result.status == 'ok') {\n        me.peers = document.peers = result.data;\n        me.timedelta = new Date().getTime() - result.currenttimemillis;\n        for (var i in result.data) {\n          var p = result.data[i];\n          p.millis = result.currenttimemillis - p.lastcontact;\n          add(p);\n        }\n        setTimeout(me.refresh, 5000);\n      }\n    });\n  }\n}\n\nme.focus = function(m){\n  if (m && (m != me.selected)){\n    if (!me.selected) me.olddistance =  me.distance = me.model.scene.camera.position.distanceTo(me.center);\n    me.selected = m;\n    var rig = m.model.rig;\n    me.recenter.set(rig.pos_x,rig.pos_y,rig.pos_z);\n    me.redistance = 1;\n  }\n  else {\n    me.selected = null;\n    me.recenter.set(0,0,0);\n    me.redistance = me.olddistance;\n    delete CURRENTDEVICEID;\n    delete CURRENTDEVICEPREFIX;\n  }\n  if (me.networkviewer) me.networkviewer.select(me.selected);\n};\n\nme.render = function(model){\n  me.now = new Date().getTime()\n  if (me.selected){\n    var rig = me.selected.model.rig;\n    me.recenter.set(rig.pos_x,rig.pos_y,rig.pos_z);\n    $('.hudms').text(((me.now+me.timedelta-me.selected.model.data.lastcontact)/1000).toFixed(1)+'s');\n  }\n  if (me.redistance){\n    var delta = me.redistance - me.distance;\n    if (!me.selected && delta < 0.001) me.redistance = null;\n    else {\n      me.distance = (delta * 0.1)+me.distance;\n      model.scene.camera.getWorldDirection(me.camv);\n      me.camv.negate().multiplyScalar(me.distance).add(me.center);\n      model.scene.camera.position.copy(me.camv);\n    }\n  }\n  me.camv.copy(me.recenter).sub(me.center).multiplyScalar(0.1);\n  me.center.add(me.camv);\n  model.scene.camera.lookAt(me.center);\n};\n\nme.delete = function(p){\n  $('.closehud').click();\n  \n  var model = p.el.api;\n  delete me.all[p.id];\n\n  var rig = model.rig;\n  var size = rig.scale_x;\n  model.animations.push(function(model){\n    if (size > 0.0001){\n      size *= 0.8;\n      rig.scale_x = size;\n      rig.scale_y = size;\n      rig.scale_z = size;\n    }\n    else {\n      me.group.remove(model.group);\n    }\n  });\n  \n  json(\"deletepeer\",\"uuid=\"+p.id, function(result) {});\n};\n\nfunction add(p){\n  if (!me.all[p.id]) {\n    me.uuids = me.uuids ? me.uuids+' '+p.id : p.id;\n    me.all[p.id] = p;\n    var el = $('<div class=\"peerorb\" id=\"orb_'+p.id+'\"/>');\n    $('body').append(el);\n    \n    var num = p.id.hashCode();\n    var count = 100000;\n    var n = (num/count)*Math.PI*2;\n    var s = 0.25;\n    var r = 10; //((count*2)/Math.PI)/20;\n    var q = 5-(num%11);\n    var x = Math.sin(n)*r;\n    var y = 0.1/(q?q:1);\n    var z = Math.cos(n)*r;\n    p.pos = new THREE.Vector3(x,y,z);\n    p.scale = new THREE.Vector3(s,s,s);\n    p.network = me;\n    p.el = el[0];\n    me.viewer.add(el[0], 'peerbot', 'peer', function(model){}, p, me.group);     \n  }\n  else {\n    Object.assign(me.all[p.id], p);\n  }\n  if (me.networkviewer) me.networkviewer.update(me.all[p.id]);\n}\n\nString.prototype.hashCode = function() {\n  var hash = 0, i, chr;\n  if (this.length === 0) return hash;\n  for (i = 0; i < this.length; i++) {\n    chr   = this.charCodeAt(i);\n    hash  = ((hash << 5) - hash) + chr;\n    hash |= 0; // Convert to 32bit integer\n  }\n  return hash;\n};\n","groups":"","ctl":"nyzsgp168c939fd22w6c","html":"","three":{"controls":[]},"db":"peerbot","desc":""},"id":"nyzsgp168c939fd22w6c","sessionid":"jhtpuq15d03ce0a74q0","time":1550082258094,"addr":"/0:0:0:0:0:0:0:1:54930","username":"mraiser"}