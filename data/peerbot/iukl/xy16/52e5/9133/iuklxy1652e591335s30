{"data":{"css":".localbrokers, .clickme{\n  cursor:pointer;\n}\n\n.localbrokers:hover,.clickme:hover{\n  color:#83bc00;\n}\n\n.localbrokers3{\n  position:absolute;\n  display:none;\n  width:600px;\n  max-width: 90vw;\n}\n\n.inlineselect{\n  display:inline-block;\n  width:200px;\n  margin-right:20px;\n}\n\n.inlinemed{\n  display:inline-block;\n  width:120px;\n  margin-right:20px;\n}\n.inlineshort{\n  display:inline-block;\n  width:60px;\n  margin-right:20px;\n}","data":[],"name":"brokers","js":"var me = this; \nvar ME = $('#'+me.UUID)[0];\n\nCURRENTDEVICEID = typeof CURRENTDEVICEID == 'undefined' ? null : CURRENTDEVICEID;\nvar prefix = CURRENTDEVICEID ? '../peerbot/remote/'+CURRENTDEVICEID+'/' : '../';\n\nme.ready = function(){\n  if (document.peers) build();\n  else setTimeout(me.ready,100);\n};\n\nfunction build(){\n  json(prefix+'peerbot/brokers', null, function(result){\n    me.brokers = result.brokers;\n    var n = 0;\n    var newhtml = '';\n    for (var i in result.brokers) {\n      n++;\n      var name = document.peers[i] ? document.peers[i].name : i == $('.localpeerid').text() ? $('.localpeername').text() : 'UNKNOWN';\n      newhtml += '<div class=\"clickme\"><div onclick=\"clickabroker(\\''+i+'\\', $(this).parent()[0]);\">'+name+'='+result.brokers[i]+'<\/div><\/div>';\n    }\n    $(ME).find('.localbrokers4').html(newhtml);\n    $(ME).find('.localbrokers3').height((n*18)+144);\n    var el = $(ME).find('.localbrokers');\n    el.text('Connection Brokers: '+n);\n    el.click(function(){\n      var el2 = $(ME).find('.localbrokers3');\n      installControl(el2[0], 'metabot', 'popupdialog', function(api){\n      }, {});\n    });\n  });\n};\n\nme.close = function(){\n  $(ME).find('.localbrokers3')[0].api.close(function(){\n    $(ME).find('.localbrokers3').css('display', 'none');\n    $(ME).find('.localbrokers3')[0].api.reset();\n  });\n}\n\nclickabroker = function(id, div){\n  var addr = me.brokers[id];\n  var i = addr.lastIndexOf(':');\n  var port = addr.substring(i+1);\n  addr = addr.substring(0,i);\n  me.oldhtml = div.innerHTML;\n  me.current = div;\n  me.currentpeer = id;\n  var gid = me.gid = guid();\n  var newhtml = \"\";\n  newhtml += \"<div class='inlineselect' id='\"+gid+\"'><\/div>\";\n  newhtml += '<div class=\"inlinemed\"><form action=\"#\"><div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\"><input class=\"mdl-textfield__input\" type=\"text\" id=\"'+gid+'-a\" value=\"'+addr+'\"><label class=\"mdl-textfield__label\" for=\"'+gid+'-a\">IP Address<\/label><\/div><\/form><\/div>';\n  newhtml += '<div class=\"inlineshort\"><form action=\"#\"><div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\"><input class=\"mdl-textfield__input\" type=\"number\" id=\"'+gid+'-b\" value=\"'+port+'\"><label class=\"mdl-textfield__label\" for=\"'+gid+'-b\">Port<\/label><\/div><\/form><\/div>';\n  newhtml += '<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--colored\" onclick=\"savebroker(\\''+id+'\\');\"><i class=\"material-icons\">check<\/i><\/button>';\n  newhtml += '<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--accent\" onclick=\"cancelbroker(\\''+id+'\\');\"><i class=\"material-icons\">close<\/i><\/button>';\n  newhtml += '<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--accent\" onclick=\"deletebroker(\\''+id+'\\');\"><i class=\"material-icons\">delete<\/i><\/button>';\n  $(div).html(newhtml).removeClass('clickme');\n  \n  function selectabroker(val){\n    var peer = document.peers[val];\n    $('#'+gid+'-a').val(peer.addr).parent()[0].MaterialTextfield.checkDirty();\n    $('#'+gid+'-b').val(peer.port).parent()[0].MaterialTextfield.checkDirty();\n  }\n\n  data = { \n    \"value\": id, \n    \"cb\": selectabroker\n  };\n  installControl('#'+gid, 'peerbot', 'selectpeer', function(){}, data);\n}\n\nfunction saveBrokers(){\n  json(prefix+'peerbot/brokers', 'brokers='+encodeURIComponent(JSON.stringify(me.brokers)), function(result){\n  });\n}\n\naddabroker = function(){\n  var pid;\n  for (var id in document.peers) if (!me.brokers[id]) { pid = id; break; }\n  var p = document.peers[pid];\n  var brok = p.addr+':'+p.port;\n  me.brokers[pid] = brok;\n  var newhtml = $('<div class=\"clickme\"><div onclick=\"clickabroker(\\''+pid+'\\', $(this).parent()[0]);\">'+p.name+'='+brok+'<\/div><\/div>');\n  $(ME).find('.localbrokers4').append(newhtml);\n  resizeCard();\n  clickabroker(pid, newhtml[0]);\n  saveBrokers();\n};\n\nsavebroker = function(){\n  var peer = $('#'+me.gid).find('select').val();\n  var addr = $('#'+me.gid+'-a').val();\n  var port = $('#'+me.gid+'-b').val();\n  delete me.brokers[me.currentpeer];\n  var brok = me.brokers[peer] = addr+':'+port;\n  var p = document.peers[peer];\n  var newhtml = $('<div class=\"clickme\"><div onclick=\"clickabroker(\\''+peer+'\\', $(this).parent()[0]);\">'+p.name+'='+brok+'<\/div><\/div>');\n  $(me.current).html(newhtml);\n  me.current = null;\n  saveBrokers();\n};\n\ncancelbroker = function(){\n  $(me.current).html(me.oldhtml).addClass('clickme');\n  me.current = null;\n};\n\ndeletebroker = function(id){\n  delete me.brokers[id];\n  $(me.current).remove();\n  me.current = null;\n  resizeCard();  \n  saveBrokers();\n};\n\nfunction resizeCard(){\n  var n = 0;\n  for (var i in me.brokers) n++;\n  var h = (n*18)+144;\n  $(ME).find('.localbrokers3').height(h).find('.dialog-card-wide').height(h);\n}","groups":"anonymous","ctl":"iuklxy1652e591335s30","html":"<div class='localbrokers'><\/div>\n<div class='localbrokers3'>\n  <div class=\"mdl-card__title\">\n    <h2 class=\"mdl-card__title-text\">Connection Brokers<\/h2>\n  <\/div>\n  <div class=\"mdl-card__supporting-text localbrokers4\"><\/div>\n  <div class=\"mdl-card__actions mdl-card--border\">\n    <a class=\"mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect\" onclick=\"addabroker();\">\n      Add\n    <\/a>\n  <\/div>\n  <div class=\"mdl-card__menu\">\n    <button class=\"mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect\" onclick=\"$(this).closest('.localbrokers3').parent()[0].api.close();\">\n      <i class=\"material-icons popupclose\">close<\/i>\n    <\/button>\n  <\/div>\n<\/div>\n","three":{"controls":[]},"db":"peerbot","desc":""},"readers":["anonymous"],"id":"iuklxy1652e591335s30","sessionid":"jvgvwg16b7a4d277bt3","time":1574954037928,"addr":"/0:0:0:0:0:0:0:1:49184","username":"admin"}