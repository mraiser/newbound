{"data":{"css":".updateselectedbutton{\n  display:none;\n  margin-top:40px;\n}","data":[],"name":"update_remote_peers","js":"var me = this; \nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(){\n  json('../peerbot/getpeerinfo', null, function(result){\n    me.my_uuid = result.id;\n    if (!document.peers){\n      json('../peerbot/connections', null, function(result){\n        if (result.status == 'ok') {\n          me.peers = document.peers = result.data;\n          buildTable();\n        }\n      });\n    }\n    else {\n      me.peers = document.peers;\n      buildTable();\n    }\n  });\n};\n\nfunction buildTable(){\n  me.checking = [];\n  var newhtml = '';\n  for (var uuid in me.peers){\n    var p = me.peers[uuid];\n    if (p.connected){\n      me.checking.push(uuid);\n      newhtml += '<tr class=\"uprow r_'+uuid+'\" data-peer=\"'+uuid+'\">'\n        + '<td class=\"mdl-data-table__cell--non-numeric\">'+p.name+'<br><div style=\"font-size:x-small;\">'+uuid+'<\/div><\/td>'\n        + '<td class=\"mdl-data-table__cell--non-numeric rowstatus\"><i>pending...<\/i><\/td>'\n        + '<\/tr>';\n    }\n  }\n  if (newhtml != ''){\n    newhtml = '<table class=\"mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp\"><thead><tr><th class=\"mdl-data-table__cell--non-numeric\">Peer<\/th><th class=\"mdl-data-table__cell--non-numeric\">Available Updates<\/th><\/tr><\/thead><tbody>'\n      + newhtml\n      + '<\/tbody><\/table>';\n  }\n  else newhtml = '<i>You are not connected to any peers.<\/i>';\n  \n  var el = $(ME).find('.update_peer_list');\n  el.html(newhtml);\n  componentHandler.upgradeAllRegistered();\n  \n  $(ME).find('td').find(':checkbox').parent().css('display', 'none').click(function(e){\n    var n = $(ME).find('td').find(':checked').length;\n    var d = n>0 ? 'inline-block' : 'none';\n    $(ME).find('.updateselectedbutton').css('display', d);\n  });\n  \n  $(ME).find('th').find(':checkbox').parent().css('display', 'none').click(function(e){\n    var n = $(ME).find('td').find(':checked').length;\n    var d = n>0 ? 'none' : 'inline-block';\n    $(ME).find('.updateselectedbutton').css('display', d);\n  });\n  \n  $(ME).find('td').find(':checkbox').parent().after('<button class=\"cancelcheckbutton mdl-button mdl-js-button mdl-button--icon mdl-button--colored\"><i class=\"material-icons\">cancel<\/i><\/button>');\n  $(ME).find('.cancelcheckbutton').click(function(e){\n    $(this).closest('tr').remove();\n    checkNext();\n  });\n  \n  checkNext();\n  checkNext();\n}\n\nfunction check(uuid){\n  var data = {\n    \"peer\": uuid,\n    \"cb\": postCheck\n  };\n  var el = $(ME).find('.r_'+uuid).find('.rowstatus')[0];\n  installControl(el, 'metabot', 'updatebutton', function(api){}, data);\n}\n\nfunction checkNext(){\n  if (me.checking.length > 0){\n    var uuid = me.checking.shift();\n    check(uuid);\n  }\n  else if ($(ME).find('.updatemsg').length == 0){\n    var n = $(ME).find('td').find(':checkbox').length;\n    if (n == 0) {\n      var el = $(ME).find('.update_peer_list');\n      el.html('<h3>Your peers are up-to-date.<\/h3>');\n    }\n    else {\n      $(ME).find('th').find(':checkbox').parent().css('display', 'inline-block')\n    }\n  }\n}\n\nfunction addReloadButton(el, msg, uuid){\n  el.find('.rowstatus').html('<button class=\"recheckbutton mdl-button mdl-js-button mdl-button--icon mdl-button--colored\"><i class=\"material-icons\">refresh<\/i><\/button><span style=\"color:red;font-size:x-small;\">Error: '+msg+'<\/span>');\n  el.find('.recheckbutton').click(function(e){\n    check(uuid);\n  });\n}\n\nfunction postCheck(isupdateable, uuid, updates, e, msg){\n  var el = $(ME).find('.r_'+uuid);\n  if (e) {\n    addReloadButton(el, msg, uuid);\n  }\n  else {\n    var el = $(ME).find('.r_'+uuid);\n    if (!isupdateable){\n      el.remove();\n    }\n    else {\n      var newhtml = \"\";\n      var u = [];\n      for (var appid in updates){\n        var app = updates[appid];\n        if (app.p){\n          newhtml += '<span data-appid=\"'+appid+'\" class=\"deletelib deletelib_'+appid+' mdl-chip mdl-chip--deletable\"><span class=\"mdl-chip__text\">'+appid+'<\/span><button type=\"button\" class=\"mdl-chip__action\"><i class=\"material-icons\">cancel<\/i><\/button><\/span>';\n          u.push(app[app.p]);\n        }\n      }\n      el.data('updates', u);\n      el.find('.rowstatus').html(newhtml);\n      el.find(':checkbox').parent().css('display', 'inline-block');\n      el.find('.cancelcheckbutton').css('display', 'none');\n      el.find('.deletelib').find('button').click(function(e){\n        var chip = $(this).closest('.deletelib');\n        var appid = chip.data('appid');\n        var app = updates[appid];\n        var rapp = app[app.p];\n        var i = u.indexOf(rapp);\n        u.splice(i,1);\n        if (u.length == 0 && me.currentlyupdating != uuid) el.remove();\n        else chip.remove();\n      });\n    }\n  }\n  checkNext();\n}\n\nfunction updateNextLib(uuid, libs){\n  var row = $(ME).find('.r_'+uuid);\n  var lib = libs.pop();\n  var newhtml = '<tr id=\"progrow_'+uuid+'\"><td colspan=\"3\"><div class=\"progmsg\"><i>Sending '+lib.name+' to '+document.peers[uuid].name+'...<\/i><\/div><div id=\"p_'+uuid+'\" class=\"mdl-progress mdl-js-progress mdl-progress__indeterminate\" style=\"width:100%;\"><\/div><\/td><\/tr>';\n  row.after(newhtml);\n  componentHandler.upgradeAllRegistered();\n  \n  $(row).find('.deletelib_'+lib.name).css('opacity', '0.5').find('button').css('display', 'none');;\n\n  function error(uuid, msg){\n    var el = $(ME).find('.r_'+uuid);\n    el.find(':checkbox').prop('checked', false).parent().parent().children().css('display', 'none');\n    el.find(':checkbox').parent().removeClass('is-checked');\n    el.find('.cancelcheckbutton').css('display', 'inline-block');\n    addReloadButton(el, msg, uuid)\n    $('#progrow_'+uuid).remove();\n    updateNextPeer();\n  }\n  \n  var progrow = $('#progrow_'+uuid);\n  \n  var url = document.URL;\n  url = url.substring(url.indexOf(':'));\n  url = url.substring(0, url.indexOf('/',3));\n  url = 'ws'+url+'/peerbot/remote/'+uuid+'/metabot/index.html';\n\n  var connection = new WebSocket(url, ['newbound']);\n\n  connection.onopen = function(){\n    console.log('Web Socket to metabot open');\n\n    json('../peerbot/remote/'+uuid+'/metabot/installlib', 'guid=r_'+uuid+'&peer='+me.my_uuid+'&lib='+lib.id, function(result){\n      connection.close();\n      if (result.status == 'ok'){\n        $('#progrow_'+uuid).remove();\n        if (libs.length > 0) {\n          row.find('.deletelib_'+lib.name).remove();\n          updateNextLib(uuid, libs)\n        }\n        else {\n          row.remove();\n          updateNextPeer();\n        }\n      }\n      else error(uuid, result.msg);\n    });\n  };\n\n  connection.onerror = function(error){\n    console.log('Web Socket to metabot error');\n  };\n\n  connection.onclose = function(error){\n    console.log('Web Socket to metabot close');\n  };\n\n  var el2 = progrow.find('#p_'+uuid);\n  connection.onmessage = function(e){\n    var val = JSON.parse(e.data);\n    var percent = val.percent;\n    var msg = val.msg;\n    if (msg) progrow.find('.progmsg').html('<i>'+msg+'<\/i>');\n    if (percent>0){\n      el2.removeClass('mdl-progress__indeterminate');\n      el2[0].MaterialProgress.setProgress(percent);\n    }\n  };\n}\n\nfunction updateNextPeer(){\n  var checkbox = $(ME).find('td').find(':checked')[0];\n  if (checkbox) {\n    var row = checkbox.closest('.uprow');\n    //$(row).find('.deletelib').find('button').css('display', 'none');\n\n    var uuid = $(row).data('peer');\n    me.currentlyupdating = uuid;\n    $(checkbox).parent().css('display', 'none').after('<i class=\"material-icons\" style=\"vertical-align:middle;\">publish<\/i>');\n    var libs = $(row).data('updates');\n    updateNextLib(uuid, libs);\n  }\n  else{\n    me.updating = false;\n    me.currentlyupdating = null;\n    var n = $(ME).find('td').find(':checkbox').length;\n    if (n == 0) {\n      var el = $(ME).find('.update_peer_list');\n      el.html('<h3>Your peers are up-to-date.<\/h3>');\n    }\n  }\n}\n\n$(ME).find('.updateselectedbutton').click(function(e){\n  $(this).css('display', 'none');\n  if (!me.updating){\n    me.updating = true;\n    updateNextPeer();\n  }\n});\n","groups":"","ctl":"twmrxl1756ad9aebct8f2","html":"<div class='update_peer_list'><\/div>\n<button class=\"updateselectedbutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored\">\n  Update Selected\n<\/button>\n","three":{"controls":[]},"db":"peerbot","desc":""},"id":"twmrxl1756ad9aebct8f2","sessionid":"jvgvwg16b7a4d277bt3","time":1604242083608,"addr":"/0:0:0:0:0:0:0:1:48346","username":"admin"}