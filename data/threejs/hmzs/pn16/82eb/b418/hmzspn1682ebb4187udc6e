{"data":{"css":"","data":[],"name":"shape","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.data = ME.DATA;\n\nme.animate = function(model){\n  me.model = model;\n  me.rebuild();\n};\n\nme.setColor = function(r, g, b){\n  var c = me.model.models[0].material.color;\n  c.r = r;\n  c.g = g;\n  c.b = b;\n}\n\n// FIXME - remove support for assets\nme.rebuild = function(){\n  var model = me.model;\n  \n  if (me.mesh){\n    var mesh = me.mesh;\n    model.models.splice(model.models.indexOf(mesh),1);\n    if (model.group) model.group.remove(mesh);\n    else model.scene.remove(mesh);\n  }\n  \n  var color = ME.DATA.color ? ME.DATA.color : 0xffff00;\n  \n  ME.DATA.color = color;\n\n  var geometry = null;\n  var d = {'color': color,\n      roughness: 0.5,\n      metalness: 0.5,\n//      shininess: 150,\n//      specular: 0xffffff,\n      flatShading : true \n  };\n  //if (ME.DATA.flatShading) d.flatShading = true;\n  \n  if (typeof ME.DATA.opacity != 'undefined'){\n    d.transparent = true;\n    d.opacity = ME.DATA.opacity;\n  }\n\n  if (ME.DATA.shape == 'sphere'){\n    var radius = ME.DATA.radius ? ME.DATA.radius : 1;\n    var widthSegments = ME.DATA.widthSegments ? ME.DATA.widthSegments : 32;\n    var heightSegments = ME.DATA.heightSegments ? ME.DATA.heightSegments : 32;\n    geometry = new THREE.SphereGeometry( radius, widthSegments, heightSegments );\n  }\n  else if (ME.DATA.shape == 'icosphere'){\n    var radius = ME.DATA.radius ? ME.DATA.radius : 1;\n    var detail = ME.DATA.detail ? ME.DATA.detail : 1;\n    geometry = new THREE.IcosahedronGeometry( radius, detail );\n    d.flatShading = true;\n  }\n  else if (ME.DATA.shape == 'text'){\n    var fname = ME.DATA.font ? ME.DATA.font : '../peerbot/helvetiker_regular.typeface.json';\n    var text = ME.DATA.text ? ME.DATA.text : ME.DATA.text = 'Text';\n    if (!document.body.fonts) document.body.fonts = {};\n    var f = document.body.fonts[fname];\n    if (!f){\n      f = document.body.fonts[fname] = {};\n      f.cbs = [];\n      var loader = new THREE.FontLoader();\n      loader.load( fname, function ( ff ) {\n        f.font = ff;\n        me.rebuild();\n      });\n    }\n    else if (f.font){\n      if (me.mesh){\n        var i = me.model.models.indexOf(me.mesh);\n        me.model.models.splice(i, 1);\n        if (me.model.group) me.model.group.remove(me.mesh);\n        else me.model.scene.remove(me.mesh);\n      }\n      geometry = new THREE.TextGeometry( text, {\n          font: f.font,\n          size: 80,\n          height: 5,\n          curveSegments: 12,\n          bevelEnabled: false,\n          bevelThickness: 10,\n          bevelSize: 8,\n          bevelSegments: 5\n      } );\n      me.getText = function(){ return ME.DATA.text; }\n      me.setText = function(val){\n        ME.DATA.text = val;\n        me.rebuild();\n      };\n      while (f.cbs[0]) f.cbs.shift(0)();\n    }\n    else f.cbs.push(me.rebuild);\n  }\n  else if (ME.DATA.shape == 'stl' || ME.DATA.shape == 'obj' || ME.DATA.shape == 'dae' || ME.DATA.shape == 'gltf'){\n    if (ME.DATA.filename){\n      var fi = ME.DATA.filename;\n      var ci = fi.indexOf(':');\n      var mdb = ci == -1 ? db : fi.substring(0, ci);\n      var mfi = ci == -1 ? fi : fi.substring(ci+1);\n      var type = mfi.substring(mfi.lastIndexOf('.')+1).toLowerCase();\n      me.model.loadAsset(mdb, mfi, type, function(mesh){\n        //model.models.push(mesh);\n        me.mesh = mesh;\n      });\n    }\n  }\n  else {\n    var x = ME.DATA.x ? ME.DATA.x : 1;\n    var y = ME.DATA.y ? ME.DATA.y : 1;\n    var z = ME.DATA.z ? ME.DATA.z : 1;\n    geometry = new THREE.BoxGeometry( x, y, z );\n  }\n  \n  if (geometry){\n    material = new THREE.MeshStandardMaterial( d );\n    var mesh = me.mesh = new THREE.Mesh( geometry, material );\n\n    model.models.push(mesh);\n    if (model.group) model.group.add(mesh);\n    else model.scene.add(mesh);\n  }\n}\n\nme.render = function(model){\n  for (var i in me.animations) me.animations[i](me, now);\n  for (var i in model.models){\n    var model = model.models[i];\n    var rig = me.model.rig;\n    model.traverse(function(a){\n      if (a instanceof THREE.SkinnedMesh){\n        for (var j in a.skeleton.bones){\n          var b = a.skeleton.bones[j];\n          b.rotation.x = rig[b.name+'_x'];\n          b.rotation.y = rig[b.name+'_y'];\n          b.rotation.z = rig[b.name+'_z'];\n        }\n      }\n    });\n  }\n};\n\nme.edit = function(div, cb){\n  var d = {\n    \"list\":[\"cube\",\"sphere\", \"icosphere\", \"text\", \"stl\", \"obj\", \"dae\", \"gltf\"],\n    \"label\":\"Shape\",\n    \"value\":ME.DATA.shape,\n    \"cb\":function(val){\n      ME.DATA.shape = val;\n      var i = me.model.models.indexOf(me.mesh);\n      me.model.models.splice(i, 1);\n      if (me.model.group) me.model.group.remove(me.mesh);\n      else me.model.scene.remove(me.mesh);\n      me.rebuild();\n      $(div).find('.shapefilename').css('display', ME.DATA.shape == 'stl' || ME.DATA.shape == 'obj' || ME.DATA.shape == 'dae' || ME.DATA.shape == 'gltf' ? 'block' : 'none');\n\n      if (cb) cb(ME.DATA);\n    }\n  };\n  \n  var el = $('<div/>');\n  $(div).append(el);\n  installControl(el[0], \"metabot\", \"select\", function(val){}, d);\n\n  el = $('<div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty\"><input type=\"color\" id=\"html5colorpicker\" value=\"'+ME.DATA.color+'\" style=\"width:60px;\"><label class=\"mdl-textfield__label\" for=\"edit3dctlpos\">Color<\/label><\/div>');\n  el.find('input').change(function(e){\n    ME.DATA.color = $(this).val();\n    me.rebuild();\n    if (cb) cb(ME.DATA);\n  });\n  $(div).append(el);\n  \n  el = $('<div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty\" style=\"display:block;\"><input type=\"text\" id=\"shapeopacity\" value=\"'+(typeof ME.DATA.opacity == 'undefined' ? '' : ME.DATA.opacity)+'\" style=\"width:60px;\"><label class=\"mdl-textfield__label\" for=\"shapeopacity\">Opacity (blank/0 to 1)<\/label><\/div>');\n  el.find('input').change(function(e){\n    var val = $(this).val();\n    ME.DATA.opacity = Number(val);\n    if (val != (''+ME.DATA.opacity)) delete ME.DATA.opacity;\n    me.rebuild();\n    if (cb) cb(ME.DATA);\n  });\n  $(div).append(el);\n  \n  el = $('<div class=\"shapefilename mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty\" style=\"display:block;\"><input type=\"text\" id=\"filename\" value=\"'+(typeof ME.DATA.filename == 'undefined' ? '' : ME.DATA.filename)+'\" style=\"width:60px;\"><label class=\"mdl-textfield__label\" for=\"filename\">Asset<\/label><\/div>');\n  el.find('input').change(function(e){\n    var val = $(this).val();\n    ME.DATA.filename = val;\n    me.rebuild();\n    if (cb) cb(ME.DATA);\n  });\n  $(div).append(el);\n  if (ME.DATA.shape != 'stl') el.css('display', 'none');\n  $(div).find('.shapefilename').css('display', ME.DATA.shape == 'stl' || ME.DATA.shape == 'obj' || ME.DATA.shape == 'dae' || ME.DATA.shape == 'gltf' ? 'block' : 'none');\n};\n","groups":"anonymous","ctl":"hmzspn1682ebb4187udc6e","html":"","three":{"controls":[],"assets":[],"animations":[],"poses":[]},"db":"threejs","desc":""},"readers":["anonymous"],"id":"hmzspn1682ebb4187udc6e","sessionid":"jvgvwg16b7a4d277bt3","time":1624717812545,"addr":"/0:0:0:0:0:0:0:1:49936","username":"admin"}