{"data":{"timer":[],"css":".padded{\n  padding:20px;\n}\n\n.appprog, .libprog{\n  width:100%;\n  height:0px;\n  background-color:#b8f04a88;\n  position:absolute;\n  bottom:0px;\n}\n\n.appprogholder, .libprogholder{\n  height:5px;\n  width:100%;\n  position:relative;\n  overflow:hidden;\n}\n\n.appsection, .libsection{\n  height:53px;\n}\n\n.progbar{\n  background-color:#84bd00;\n  width:0%;\n  height:5px;\n  position:absolute;\n  top:0px;\n  left:0px;\n}\n\n.installmsg{\n  white-space:nowrap;\n  overflow:hidden;\n}\n\n.appinstaller{\n  position:relative;\n  width:0px;\n  height:0px;\n  border-radius:0px;\n  top:40px;\n  left:40px;\n  background-color:white;\n}\n\n.tryagain, .cancelinstall {\n  margin-top:10px;\n  margin-right:40px;\n  display:none;\n}\n","data":[],"name":"installapp","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nvar card = $(ME).find('.appinstaller');\n\nvar app = ME.DATA;\nvar peer = app.selectedpeer ? app.selectedpeer : app.peers[0];\nvar rapp = getByProperty(peer.apps.list, 'id', app.id);\nvar installed = 0;\nvar count = 0;\n\n//FIXME - add code on fail\n\nme.wscb = function(data){\n  if (data.msg) card.find('.libmsg2').html(data.msg);\n  if (data.percent) {\n    card.find('.libprogbar')[0].indeterminate = false;\n    card.find('.libprogbar').css('width', data.percent+'%');\n    \n    var n = count; //rapp.libraries.length;\n    var p = (50 + (100*installed) + data.percent) / (n+1);\n    card.find('.appprogbar').css('width', p+'%');\n    card.find('.appmsg2').html('Installing Library '+(installed+1)+' of '+n+'...');\n  }\n};\n\nfunction handleError(){\n  card.find('.appprogbar')[0].indeterminate = false;\n  card.find('.libprogbar')[0].indeterminate = false;\n  card.find('.appprog').animate({'height':'0px'}, 1000);\n  card.find('.libprog').animate({'height':'0px'}, 1000, function(){\n    $(ME).find('.tryagain').css('display', 'inline-block');\n    $(ME).find('.cancelinstall').css('display', 'inline-block');\n  });\n}\n\nme.ready = function(){\n  \n  card.animate({'width':'80px','height':'80px', 'border-radius':'40px', 'top':'0px', 'left':'0px'},500, function(){\n    card.animate({'width':'100%','height':'120px', 'border-radius':'0px'},2000, function(){\n      install();\n    });\n  });\n};\n\nfunction install(){      \n  peer = app.selectedpeer ? app.selectedpeer : app.peers[0];\n  rapp = getByProperty(peer.apps.list, 'id', app.id);\n  installed = 0;\n  \n  $(ME).find('.tryagain').css('display', 'none');\n  $(ME).find('.cancelinstall').css('display', 'none');\n  card.find('.appmsg1').html('Installing App '+rapp.name+' v'+rapp.version+' from '+peer.name+' ('+peer.id+')');\n  card.find('.appmsg2').html('Requesting app metadata...');\n  card.find('.libmsg2').html('');\n  card.find('.appprog').animate({'height':'5px'}, 1000);\n  indeterminate(card.find('.appprogbar')[0]);\n  json('../peerbot/remote/'+peer.id+'/metabot/libraries', null, function(result){\n\n    if (result.status != 'ok') {\n      card.find('.appmsg2').html('Error requesting app metadata.');\n      handleError();\n      return;\n    }\n\n    var libs = [];\n    for (var i in rapp.libraries){\n      var a = rapp.libraries[i]\n      var a1 = getByProperty(document.body.libraries, 'id', a);\n      var a2 = getByProperty(result.data.data.list, 'id', a);\n      \n      if (a2) {\n        if (!a1 || (Number(a2.version)>Number(a1.version))) libs.push(a);\n      }\n      else {\n        card.find('.appmsg2').html('Missing library '+lib.name+' v'+lib.version+' from '+peer.name+' ('+peer.id+')');\n        handleError();\n        return;\n      }\n    }\n    count = libs.length;\n\n    function send_install(appinfo, cb){\n      var ps = appinfo.peers;\n      var sp = appinfo.selectedpeer;\n      appinfo.peers = [];\n      appinfo.selectedpeer = null;\n      var args = {appinfo: appinfo};\n      args = encodeURIComponent(JSON.stringify(args));\n      json('../botmanager/execute', 'db=metabot&id=utursv16172165563k55&args='+args, function(result){\n        \n        if (result.status != 'ok') {\n          card.find('.appmsg2').html('Error updating app metadata.');\n          handleError();\n          return;\n        }\n\n        cb(result);\n      });\n      appinfo.peers = ps;\n      appinfo.selectedpeer = sp;\n    }\n\n    function done(){\n      card.find('.libprog').animate({'height':'0px'}, 1000, function(){\n        card.find('.libmsg1').html('');\n        card.find('.libmsg2').html('');\n      });\n\n      card.find('.appmsg2').html('Finishing installation...');\n      send_install(rapp, function(result){\n        \n        if (result.status != 'ok') {\n          card.find('.appmsg2').html('Error installing app.');\n          handleError();\n          return;\n        }\n\n        card.find('.appmsg2').html('Installation complete.');\n        card.find('.appprogbar').css('width', '100%');\n\n        closeDialog(ME.DATA.cb);\n      });\n    }\n\n    function popNext(){\n      if (libs.length>0){\n        card.find('.appprogbar')[0].indeterminate = false;\n        var rlib = libs.shift();\n        var lib = getByProperty(result.data.data.list, 'id', rlib);\n        if (true) { //(Number(rlib.version)>Number(lib.version)){\n          card.find('.appmsg2').html('Installing Library '+lib.name+'...');\n          card.find('.libmsg1').html('Installing Library '+lib.name+' v'+lib.version+' from '+peer.name+' ('+peer.id+')');\n          card.find('.libmsg2').html('');\n          card.find('.libprog').animate({'height':'5px'}, 1000);\n          indeterminate(card.find('.libprogbar')[0]);\n          json('../metabot/installlib', 'guid='+me.UUID+'&peer='+encodeURIComponent(peer.id)+'&lib='+encodeURIComponent(lib.id), function(result){\n\n            if (result.status != 'ok') {\n              card.find('.appmsg2').html('Error installing library '+lib.name+' v'+lib.version+' from '+peer.name+' ('+peer.id+')');\n //             card.find('.libmsg1').html('');\n //             card.find('.libmsg2').html('');\n              handleError();\n              return;\n            }\n            else{\n              installed++;\n              popNext();\n            }\n          });\n        }\n        else {\n          installed++;\n          popNext();\n        }\n      }\n      else done();\n    }\n    popNext();\n  });\n};\n\nfunction indeterminate(progbar){\n  progbar.indeterminate = true;\n  var dur = 800;\n  $(progbar).css('left', '-50%').css('width', '50%').animate({'left':'100%'},dur, function(){\n    function update(){\n      if (progbar.indeterminate){\n        dur = dur == 800 ? 1500 : 800;\n        $(progbar).css('left', '-50%').animate({'left':'100%'},dur, update);\n      }\n      else $(progbar).css('left', '0%').css('width', '0%');\n    }\n    update();\n  });\n  \n}\n\nfunction closeDialog(cb){\n  $(ME).find('.tryagain').css('display', 'none');\n  $(ME).find('.cancelinstall').css('display', 'none');\n  card.find('.appprog').animate({'height':'0px'}, 1000, function(){\n    card.find('.appmsg1').html('');\n    card.find('.appmsg2').html('');\n\n    card.animate({'width':'80px','height':'80px', 'border-radius':'40px'},2000, function(){\n        $('.appactions').css('display', 'block');\n      card.animate({'width':'0px','height':'0px', 'border-radius':'0px', 'top':'40px', 'left':'40px'},500, function(){\n        if (cb) cb();\n      });\n    });\n  });\n}\n    \n$(ME).find('.tryagain').click(install);\n$(ME).find('.cancelinstall').click(closeDialog);","groups":"anonymous","html":"<div class=\"mdl-shadow--2dp appinstaller\">\n  <div class='padded'>\n      <div class='appsection'>\n        <div class='appmsg1 installmsg'><\/div>\n        <div class='appmsg2 installmsg'><\/div>\n        <div class='appprogholder'><div class='appprog'><div class='appprogbar progbar'><\/div><\/div><\/div>\n        <button class=\"tryagain mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored\">Try Again<\/button><button class=\"cancelinstall mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent\">Cancel<\/button>\n      <\/div>\n      <div class='libsection'>\n        <div class='libmsg1 installmsg'><\/div>\n        <div class='libmsg2 installmsg'><\/div>\n        <div class='libprogholder'><div class='libprog'><div class='libprogbar progbar'><\/div><\/div><\/div>\n      <\/div>\n  <\/div>\n<\/div>","ctl":"mhvnlv16142fabd2er73f","cmd":[],"db":"metabot","desc":""},"readers":["anonymous"],"id":"mhvnlv16142fabd2er73f","sessionid":"jvgvwg16b7a4d277bt3","time":1574954038323,"addr":"/0:0:0:0:0:0:0:1:49158","username":"admin"}