{"data":{"timer":[],"css":".applist{\n  display: flex;\n  justify-content: center;\n  width:100%;\n  flex-wrap: wrap;\n}\n\n.applist-filters{\n  margin-left:auto;\n  margin-right:auto;\n  margin-top:20px;\n  margin-bottom:10px;\n}\n\n.app-card{\n  height:0px;\n  width:0px;\n}\n\n.app-card{\n  overflow:hidden;\n}","data":[],"name":"applist","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(){\n  json('../securitybot/listapps', null, function(result){\n    document.body.securityapps = result.data;\n\n    json('../metabot/apps', null, function(result){\n      $('#publish-tab')[0].api.setApps(result.data);\n      me.data = result.data;\n      sortApps();\n      var listel = $(ME).find('.applist');\n      for (var i in result.data.list){\n        var app = result.data.list[i];\n        app.installed = result.data.installed.indexOf(app.class) != -1;\n        app.local = true;\n        \n        var args = { \n          \"db\": \"metabot\",\n          \"id\": \"appcard\",\n          \"data\": app\n        };\n        \n        var claz = app.installed ? 'app-active' : app.local ? 'app-inactive' : 'app-remote';\n        listel.append($('<div id=\"appcard_'+app.id+'\" class=\"data-control app-card '+claz+'\"/>').data('control', args));\n      }\n      updateFilters();\n      activateControls(listel[0]);\n      \n      json('../peerbot/connections', null, function(result){\n        me.peers = document.body.peers = result.data;\n        var poplist = [];\n        for (var i in result.data){\n          var peer = result.data[i];\n          if (peer.connected) poplist.push(peer);\n        }\n        \n        function popnext(){\n          if (poplist.length>0){\n            scan(poplist.shift(), popnext);\n          }\n        }\n        popnext();\n        \n      });\n    });\n  });\n};\n\nfunction sortApps(){\n  me.data.list.sort(function(a,b) {return (a.name.toLowerCase() > b.name.toLowerCase()) ? 1 : ((b.name.toLowerCase() > a.name.toLowerCase()) ? -1 : 0);} ); \n}  \n\nfunction scan(peer, cb){\n  $.getJSON('../peerbot/remote/'+peer.id+'/metabot/apps', function(result){\n    cb();\n    me.peers[peer.id].apps = result.data;\n    for (var i in result.data.list){\n      var app = result.data.list[i];\n      if (app.forsale){\n        app.peers = [ peer ];\n        var lapp = getByProperty(me.data.list, 'id', app.id);\n        if (!lapp) {\n          app.remote = true;\n          me.data.list.push(app);\n          lapp = app;\n\n          sortApps();\n\n          var args = { \n            \"db\": \"metabot\",\n            \"id\": \"appcard\",\n            \"data\": app\n          };\n\n          var n = me.data.list.indexOf(app);\n          var listel = $(ME).find('.applist');\n          var el = $('<div class=\"data-control app-card app-remote\"/>')[0];\n          $(listel.children()[n]).before(el);\n          updateFilters();\n          $(el).data('control', args);\n          activateControl(el, function(){});\n        }\n        else if (!lapp.peers) lapp.peers = app.peers;\n        else if (lapp.peers.indexOf(peer) == -1) {\n          if (!lapp.available || Number(lapp.available)<Number(app.version))\n            lapp.peers.unshift(peer);\n          lapp.peers.push(peer);\n        }\n\n        if (!lapp.available) lapp.available = lapp.version;\n        if (Number(lapp.available) < Number(app.version) && lapp.author == app.author) { \n          lapp.available = app.version;\n          var card = $(ME).find('#appcard_'+app.id);\n          card.find('.appupdatebutton').css('display', 'block'); //.click(function(){\n//            setTimeout(function(){\n//              card.find('.app-update-button').click();\n//            }, 500);\n//          });\n\n          var name = lapp.name+' v'+lapp.version+' (v'+lapp.available+' available)';\n          card.find('.appinfo-title').text(name);\n          card.find('.app-card-image__filename').text(name);\n\n        }\n      }\n    }\n  });\n}\n\nfunction updateFilters(){\n  $(ME).find('.app-active').animate({width:'228px',height:\"228px\"},500);\n  \n  var args = { inactive: $(ME).find('#appfilter-switch-1').prop('checked'), remote: $(ME).find('#appfilter-switch-2').prop('checked') }\n  if (args.inactive){\n    $(ME).find('.app-inactive').animate({width:'228px',height:\"228px\"},500);\n  }\n  else{\n    $(ME).find('.app-inactive').animate({width:'0px',height:\"0px\"},500);\n  }\n\n  if (args.remote){\n    $(ME).find('.app-remote').animate({width:'228px',height:\"228px\"},500);\n  }\n  else{\n    $(ME).find('.app-remote').animate({width:'0px',height:\"0px\"},500);\n  }\n\n  if (!me.filters || args.inactive != me.filters.inactive || args.remote != me.filters.remote){\n    me.filters = args;\n    json('../botmanager/newdb', 'db=runtime', function(result){\n      json('../botmanager/write', 'db=runtime&id=metabot_applist_filters&data='+encodeURIComponent(JSON.stringify(args)), function(result){});\n    });\n  }\n}\n\n$(ME).find('.mdl-switch').click(updateFilters);\n\njson('../botmanager/read', 'db=runtime&id=metabot_applist_filters', function(result){\n  if (result.data){\n    me.filters = result.data;\n    var x = $(ME).find('#appfilter-switch-1').prop('checked', result.data.inactive).parent()[0]; \n    var y = $(ME).find('#appfilter-switch-2').prop('checked', result.data.remote).parent()[0];\n    if (x.MaterialSwitch) x.MaterialSwitch.checkToggleState();\n    if (y.MaterialSwitch) y.MaterialSwitch.checkToggleState();\n  }\n});\n\n","groups":"","ctl":"mjosgm16199a38fa5r181f","html":"<table class='applist-filters'>\n  <tr>\n    <td width='200px'>\n      <label class=\"mdl-switch mdl-js-switch mdl-js-ripple-effect\" for=\"appfilter-switch-1\">\n        <input type=\"checkbox\" id=\"appfilter-switch-1\" class=\"mdl-switch__input\">\n        <span class=\"mdl-switch__label\">Inactive<\/span>\n      <\/label>\n    <\/td>\n    <td width='200px'>\n      <label class=\"mdl-switch mdl-js-switch mdl-js-ripple-effect\" for=\"appfilter-switch-2\">\n        <input type=\"checkbox\" id=\"appfilter-switch-2\" class=\"mdl-switch__input\">\n        <span class=\"mdl-switch__label\">Available<\/span>\n      <\/label>\n    <\/tr>\n<\/table>\n  \n  \n<div class='applist'><\/div>","cmd":[],"db":"metabot","desc":""},"id":"mjosgm16199a38fa5r181f","sessionid":"jhtpuq15d03ce0a74q0","time":1543777411514,"addr":"/0:0:0:0:0:0:0:1:53622","username":"mraiser"}