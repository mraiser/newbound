{"data":{"css":"select{\n  background-color:#7c7f86;\n  color:white;\n}\n\n.padmex{\n  padding-left:50px;\n}\n\n.butpad{\n  padding:10px;\n  font-size:large;\n  border:none;\n  text-transform: uppercase;\n}","data":[],"name":"edittimer","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nTB = me;\n\nme.ready = function(){\n\n  //  var data = { \"db\": db, \"ctl\": id, \"timer\": timer, \"name\": timer.name, \"data\": me.CTLDATA, \"ctlapi\": me };\n  \n  buildDigitSelect(0, 1, '.h1select');\n  buildDigitSelect(0, 5, '.m1select');\n  buildDigitSelect(0, 3, '.d1select');\n  buildDigitSelect(0, 9, '.digitselect');\n  var thisyear = new Date().getFullYear();\n  buildDigitSelect(thisyear, thisyear+10, '.yearselect');\n  \n  var units = '';\n  var tus = [ 'milliseconds', 'seconds', 'minutes', 'hours', 'days' ];\n  i = tus.length;\n  while (i-->0) units = '<option>'+tus[i]+'<\/option>' + units;\n  $('.timeunitselect').html(units).trigger('create');\n  \n  var months = '';\n  var ms = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];\n  i = ms.length;\n  while (i-->0) months = '<option>'+ms[i]+'<\/option>' + months;\n  $('.monthselect').html(months).trigger('create');\n  \n  var newhtml = ''\n  for (var i in ME.DATA.ctlapi.CTLDATA.cmd){\n    var c = ME.DATA.ctlapi.CTLDATA.cmd[i];\n    newhtml += '<option value=\"'+c.id+'\">'+c.name+'<\/option>';\n  }\n\n  $('#timer_edit_task').html(newhtml);\n\n  editTimer(ME.DATA.timer.id);\n};\n\nvar months = '';\nvar ms = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];\ni = ms.length;\nwhile (i-->0) months = '<option>'+ms[i]+'<\/option>' + months;\n$('.monthselect').html(months);\n\n  \nfunction buildDigitSelect(start, stop, el){\n  var digits = '';\n  var i = stop+1;\n  while (i-->start) digits = '<option>'+i+'<\/option>' + digits;\n  $(el).html(digits);\n}\n\nfunction deleteTimer(){\n  var uuid = $('#timer_edit')[0].uuid;\n  if (confirm('Are you sure you want to delete this timer? This cannot be undone.')) json('../botmanager/timer', 'mode=kill&id='+encodeURIComponent(uuid), function(result){\n    if (result.status != 'ok') alert(result.msg);\n    else json('../botmanager/delete', 'db='+ME.DATA.db+'&id='+encodeURIComponent(uuid), function(result){\n      var d = getByProperty(ME.DATA.ctlapi.CTLDATA.timer, 'id', uuid);\n      var i = ME.DATA.ctlapi.CTLDATA.timer.indexOf(d);\n      ME.DATA.ctlapi.CTLDATA.timer.splice(i,1);\n      ME.DATA.ctlapi.saveControl();\n      ME.DATA.ctlapi.buildTimerList();\n      closeTimer();\n    });\n  });\n}\n$('#deletethetimerbutton').click(deleteTimer);\n\nfunction closeTimer(){\n  $('.api-main').css('display', 'block');\n  $('.api-edittimer').css('display', 'none');\n}\n$('#cancelthetimerbutton').click(closeTimer);\n\n\nfunction saveTimer(){\n  var DB = ME.DATA.db;\n  var data = $('#timer_edit')[0].data;\n  var uuid = $('#timer_edit')[0].uuid;\n  data.cmd = $('#timer_edit_task').val();\n  data.cmddb = DB;\n  data.params = {};\n\n  var ok = true;\n  var cmd = getByProperty(ME.DATA.cmd, 'id', data.cmd);\n  $('.cp_'+data.cmd).each(function(i, el){\n    var p = $('#timer_edit_params')[0].data.params[i];\n    try\n    {\n      var v = p.type.indexOf('JSON') == 0 ? JSON.parse(el.value) : el.value;\n      data.params[p.name] = v;\n    }\n    catch (x) { alert('Parameter '+p.name+' is not valid JSON'); ok = false; }\n  });\n  \n  if (!ok) return;\n\n  if ($('#timer_edit_start-1').prop('checked')) {\n    data.start = 0;\n    data.startunit = 'milliseconds';\n  }\n  else if ($('#timer_edit_start-2').prop('checked')){\n    var d1 = $('#tes2-1').val();\n    var d2 = $('#tes2-2').val();\n    data.start = parseInt(d1)*10 + parseInt(d2);\n    data.startunit = $('#tes2-unit').val();\n  }\n  else {\n    data.start = new Date(extractTimerStart()).getTime();\n    data.startunit = 'milliseconds';\n  }\n  \n  data.repeat = $('#timer_edit_repeat').prop('checked');\n  \n  var d1 = $('#timer_edit_repeat1').val();\n  var d2 = $('#timer_edit_repeat2').val();\n  data.interval = parseInt(d1)*10 + parseInt(d2);\n  data.intervalunit = $('#timer_edit_repeat_unit').val();\n\n  json('../botmanager/timer', 'mode=set&params='+encodeURIComponent(JSON.stringify(data))+'&id='+encodeURIComponent(uuid), function(result){\n    if (result.status != 'ok') alert(result.msg);\n    else json('../botmanager/write', 'db='+DB+'&data='+encodeURIComponent(JSON.stringify(data))+'&id='+encodeURIComponent(uuid), function(result){\n      if (result.status != 'ok') alert(result.msg);\n      else $('#cancelthetimerbutton').click();\n    });\n  });\n}\n$('#savethetimerbutton').click(saveTimer);\n\nfunction extractTimerStart(){\n    var h = $('#tes3-h1').val()+''+$('#tes3-h2').val();\n    var m = $('#tes3-m1').val()+''+$('#tes3-m2').val();\n    var a = $('#tes3-ampm').val();\n\n    var mm = $('#tes3-m').val();\n    var dd = $('#tes3-d1').val()+''+$('#tes3-d2').val();\n    var y = $('#tes3-y').val();\n    \n    return mm+\" \"+dd+\", \"+y+\" \"+h+\":\"+m+\" \"+a;\n}\n\n\n\nfunction editTimer(id, cb){\n  $('#timer_edit_msg').html('');\n  adjustMinuteSelect('0', 'tes3-h2');\n  adjustDaySelect(\"tes3-m\", \"tes3-d\", \"tes3-y\");\n  var data = ME.DATA.timer;\n  $('.timer_edit_name').text(data.name);\n  $('#timer_edit')[0].uuid = id;\n  json('../botmanager/read', 'db='+ME.DATA.db+'&id='+encodeURIComponent(id), function(result){\n    if (result.status != 'ok') error(result.msg, 'timer_edit_msg');\n    else {\n      var d = result.data;\n      $('#timer_edit')[0].data = d;\n      \n      if (d.cmd) $('#timer_edit_task').val(d.cmd);\n      setTaskParams($('#timer_edit_task').val());\n      var tes = d.start == 0 ? 1 : d.start < 100 ? 2 : 3;\n      $('.timer_edit_start').prop('checked', false);\n      $('#timer_edit_start-'+tes).prop('checked', true);\n      \n      if (tes == 2) {\n        var d1 = Math.floor(d.start/10);\n        var d2 = d.start - (d1 * 10);\n        $('#tes2-1').val(''+d1);\n        $('#tes2-2').val(''+d2);\n        $('#tes2-unit').val(d.startunit);\n      }\n      else if (tes == 3) {\n        var date = new Date();\n        date.setTime(d.start);\n        \n        var h = date.getHours();\n        var pm = h > 11;\n        if (h>12) h -= 12;\n        else if (h == 0) h = 12;\n        \n        var h1 = Math.floor(h / 10);\n        var h2 = h - (h1 * 10);\n        $('#tes3-h1').val(''+h1);\n        $('#tes3-h2').val(''+h2);\n        \n        var m = date.getMinutes();\n        var m1 = Math.floor(m / 10);\n        var m2 = m - (m1 * 10);\n        $('#tes3-m1').val(''+m1);\n        $('#tes3-m2').val(''+m2);\n        $('#tes3-ampm').val(pm ? 'PM' : 'AM');\n        $('#tes3-m').val(ms[date.getMonth()]);\n        \n        var day = date.getDate();\n        var d1 = Math.floor(day / 10);\n        var d2 = day - (d1 * 10);\n        $('#tes3-d1').val(''+d1);\n        $('#tes3-d2').val(''+d2);\n        $('#tes3-y').val(date.getFullYear());\n      }\n      $('#timer_edit_repeat').prop('checked', d.repeat);\n      $(\"#timer_edit_repeat_data\").css(\"display\", d.repeat ? \"inline\" : \"none\");\n      var x = d.interval;\n      var x1 = Math.floor(x / 10);\n      var x2 = x - (x1 * 10);\n      $('#timer_edit_repeat1').val(''+x1);\n      $('#timer_edit_repeat2').val(''+x2);\n      $('#timer_edit_repeat_unit').val(d.intervalunit);\n       \n      if (cb) cb();\n    }\n  });\n}\n\nfunction setTaskParams(cmd){\n  if (!cmd) return;\n  var data = getByProperty(ME.DATA.ctlapi.CTLDATA.cmd, 'id', cmd);\n  json('../botmanager/read', 'db='+ME.DATA.db+'&id='+encodeURIComponent(data.java), function(result){\n    var params = result.data.params;\n    var timer = $('#timer_edit')[0].data;\n    //console.log(JSON.stringify(params));\n    var newhtml = '';\n    if (!timer.params) timer.params = {};\n    for (var i in params){\n      var p = params[i];\n      var v = timer.params[p.name];\n      if (!v) v = \"\";\n      if (p.type.indexOf('JSON') == 0) v = JSON.stringify(v);\n      var id = 'cp_'+cmd+'_'+i;\n      var type = p.type == 'int' || p.type == 'double' || p.type == 'float' ? 'number' : 'text';\n      newhtml += \"<label for='\"+id+\"'>\"+p.type+' '+p.name+\" = <\/label>\";\n      newhtml += \"<input id='\"+id+\"' type='\"+type+\"' class='cp_\"+cmd+\"' value='\"+v+\"'><br>\";\n    }\n    if (newhtml == '') newhtml = '<i>This command has no input parameters<\/i>';\n    else newhtml = '<div>'+newhtml+'<\/div>';\n    $('#timer_edit_params').html(newhtml)[0].data = result.data;\n  });\n}\nme.setTaskParams = setTaskParams;\n\nfunction adjustDaySelect(m, d, y){\n    var mm = $('#'+m).val();\n    var d1 = $('#'+d+'1').val();\n    var d2 = $('#'+d+'2').val();\n    var y = $('#'+y).val();\n  \n    var numdays = 31;\n    while (true) try {\n      var date = new Date(mm+' '+numdays+', '+y);\n      if (date.getMonth() == ms.indexOf(mm)) break;\n      numdays--;\n    }\n    catch (x) { numdays--; }\n    \n    var ds = Math.floor(numdays/10);\n    buildDigitSelect(0, ds, \"#\"+d+\"1\");\n    $('#'+d+'1').val(d1);\n    d1 = $('#'+d+'1').val();\n    \n    buildDigitSelect(d1 == '0' ? 1 : 0, d1 == ''+ds ? numdays - (ds * 10) : 9, '#'+d+'2');\n    $('#'+d+'2').val(d2);\n}\n\nfunction adjustMinuteSelect(h1, h2el){\n  var val = $(\"#\"+h2el).val();\n  var stop = h1 == '0' ? 9 : 2;\n  var start = h1 == '0' ? 1 : 0;\n  buildDigitSelect(start, stop, \"#\"+h2el);\n  $(\"#\"+h2el).val(val);\n}\n","groups":"","html":"<div id='timer_edit' class='padmex'>\n  <h1>Edit Timer Task<\/h1>\n  <h2 id='timer_edit_name' class='timer_edit_name'><\/h2>\n  \n  <div>\n      <label for='timer_edit_task'>Fire Command:<\/label>\n      <select id='timer_edit_task' class='cmdselect' onchange='TB.setTaskParams($(this).val());'><\/select>\n  <\/div>\n  <br><br>With Values:<br>\n  <div id='timer_edit_params'><\/div>\n  <br><br>\n  <div data-role=\"controlgroup\">\n      <input type=\"radio\" name=\"timer_edit_start\" id=\"timer_edit_start-1\" class=\"timer_edit_start\" value=\"0\" checked=\"checked\" />\n      <label for=\"timer_edit_start-1\">At Startup<\/label>\n      <br>\n      <input type=\"radio\" name=\"timer_edit_start\" id=\"timer_edit_start-2\" class=\"timer_edit_start\" value=\"1\" />\n      <label for=\"timer_edit_start-2\">\n          <select id='tes2-1' data-role='none' class='digitselect'><\/select><select id='tes2-2' data-role='none' class='digitselect'><\/select>\n          <select id='tes2-unit' data-role='none' class='timeunitselect'><\/select>\n          After Startup\n      <\/label>\n      <br>\n      <input type=\"radio\" name=\"timer_edit_start\" id=\"timer_edit_start-3\" class=\"timer_edit_start\" value=\"2\" />\n      <label for=\"timer_edit_start-3\">\n          At a specific time: \n          <br>\n          <select id='tes3-h1' data-role='none' class='h1select' onchange='TB.adjustMinuteSelect($(this).val(), \"tes3-h2\");'><\/select><select id='tes3-h2' data-role='none' class='digitselect'><\/select> : \n          <select id='tes3-m1' data-role='none' class='m1select'><\/select><select id='tes3-m2' data-role='none' class='digitselect'><\/select> \n          <select id='tes3-ampm' data-role='none'><option>AM<\/option><option>PM<\/option><\/select> \n          on \n          <select id='tes3-m' data-role='none' class='monthselect' onchange='TB.adjustDaySelect(\"tes3-m\", \"tes3-d\", \"tes3-y\");'><\/select>\n          <select id='tes3-d1' data-role='none' class='d1select' onchange='TB.adjustDaySelect(\"tes3-m\", \"tes3-d\", \"tes3-y\");'><\/select><select id='tes3-d2' data-role='none' class='digitselect'><\/select> , \n          <select id='tes3-y' data-role='none' class='yearselect' onchange='TB.adjustDaySelect(\"tes3-m\", \"tes3-d\", \"tes3-y\");'><\/select>\n      <\/label>\n  <\/div>\n  <br><br>\n  <div>\n      <input style='vertical-align:top;' type='checkbox' id='timer_edit_repeat' onchange='$(\"#timer_edit_repeat_data\").css(\"display\", $(this).prop(\"checked\") ? \"inline\" : \"none\");'>\n      <label for='timer_edit_repeat'>\n          Repeat\n          <span id='timer_edit_repeat_data' style='display:none;'>\n            Every \n            <select id='timer_edit_repeat1' data-role='none' class='digitselect' onclick='event.stopPropagation();'><\/select><select id='timer_edit_repeat2' data-role='none' class='digitselect' onclick='event.stopPropagation();'><\/select>\n            <select id='timer_edit_repeat_unit' data-role='none' class='timeunitselect' onclick='event.stopPropagation();'><\/select>\n          <\/span>\n      <\/label>\n  <\/div>\n  <br>\n  <div id='timer_edit_msg'><\/div>\n  <br><br>\n  <button class='bggreen butpad' id='savethetimerbutton'>save<\/button>\n  <button class='bggray butpad' id='cancelthetimerbutton'>cancel<\/button>\n  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n  <button class='bgwhite butpad' id='deletethetimerbutton'>delete<\/button>\n<\/div>","ctl":"ypzrnj16170ff1e19kb7c","db":"metabot","desc":""},"id":"ypzrnj16170ff1e19kb7c","sessionid":"jhtpuq15d03ce0a74q0","time":1533132559613,"username":"mraiser"}