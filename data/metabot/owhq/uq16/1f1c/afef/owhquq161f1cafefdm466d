{"data":{"css":".outmost{\n  position:relative;\n}\n\n.addlib {\n  top:0px;\n  left:280px;\n  position:absolute;\n  display:none;\n}","data":[],"name":"libraryselect","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nvar prefix = typeof CURRENTDEVICEID == 'string' ? '../peerbot/remote/'+CURRENTDEVICEID+'/' : '../';\nvar cbs = [];\n\nme.ready = function(){\n  componentHandler.upgradeAllRegistered();\n  \n  var validchars = 'abcdefghijklmnopqrstuvwxyz_0123456789';\n\n  function validateString(val){\n    if (val.length == 0) return false;\n    var i = val.length;\n    while (i-->0) if (validchars.indexOf(val.charAt(i)) == -1) return false;\n    return true;\n  }\n\n  $.getJSON(prefix + 'metabot/libraries', function(result){\n    if (result.data.data) result.data = result.data.data;\n    me.list = result.data.list;\n    sortLibs();\n    \n    rebuild();\n\n    if (ME.DATA.cb) me.change(ME.DATA.cb);\n    \n    var aa = ME.DATA.allowadd ? true : false;\n    if (aa){\n      $(ME).find('.addlib').css('display', 'block').click(function(){\n        var data = {\n          title:'New Library',\n          text:'New library name',\n          subtext:'lowercase letters, numbers, and underscores only.',\n          cancel:'cancel',\n          ok:'create',\n          validate:validateString,\n          cb: function(val){\n            json(prefix + 'botmanager/newdb', 'db='+encodeURIComponent(val)+'&readers='+encodeURIComponent(JSON.stringify([\"anonymous\"])), function(result){\n              json(prefix + 'botmanager/write', 'id=tasklists&data=%7B%7D&db='+encodeURIComponent(val), function(result){\n                me.list.unshift(val);\n                me.value = val;\n                rebuild();\n                for (var i in cbs) cbs[i](val);\n              });\n            });\n          }\n        };\n        installControl($(ME).find('.dialogdiv')[0], 'metabot', 'promptdialog', function(){}, data);\n      });    \n\n    }\n  });\n};\n\nfunction sortLibs(){\n  me.list.sort(function(a,b) {return (a.name.toLowerCase() > b.name.toLowerCase()) ? 1 : ((b.name.toLowerCase() > a.name.toLowerCase()) ? -1 : 0);} ); \n}  \n\nfunction rebuild(){\n  var l = ME.DATA.label ? ME.DATA.label : 'Select a Library';\n  var a = ME.DATA.allownone ? true : false;\n\n  var data = {\n    label: l,\n    list: me.list,\n    value: ME.DATA.value,\n    allownone:a,\n    cb:function(val){\n      for (var i in cbs) cbs[i](val);\n    },\n    ready:function(api){\n      if (ME.DATA.ready) ME.DATA.ready(me);\n    }\n  };\n\n  installControl($(ME).find('.libselwrap')[0], 'metabot', 'select', function(api){}, data);\n}\n\nme.change = function(cb){\n  cbs.push(cb);\n};\n\nme.value = function(){\n  return $(ME).find('select').val();\n};\n","groups":"anonymous","ctl":"owhquq161f1cafefdm466d","html":"<div class='outmost'>\n  <div class='libselwrap'><\/div>\n  <button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--colored addlib addbut\">\n    <i class=\"material-icons\">add<\/i>\n  <\/button>\n<\/div>\n<div class='dialogdiv'><\/div>","three":{"controls":[]},"db":"metabot","desc":""},"readers":["anonymous"],"id":"owhquq161f1cafefdm466d","sessionid":"jvgvwg16b7a4d277bt3","time":1574954038390,"addr":"/0:0:0:0:0:0:0:1:49188","username":"admin"}