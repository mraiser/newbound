{"data":{"css":"select{\n  background-color:#7c7f86;\n  color:white;\n}\n\n.padmex{\n  padding-left:50px;\n}\n\n.butpad{\n  padding:10px;\n  font-size:large;\n  border:none;\n  text-transform: uppercase;\n}\n\n.selecteventname{\n  margin-bottom:20px;\n}\n\n.eventpicker{\n  width:16px;\n}","data":[],"name":"editevent","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(){\n  var newhtml = ''\n  for (var i in ME.DATA.ctlapi.CTLDATA.cmd){\n    var c = ME.DATA.ctlapi.CTLDATA.cmd[i];\n    newhtml += '<option value=\"'+c.id+'\">'+c.name+'<\/option>';\n  }\n\n  $('#event_edit_task').html(newhtml);\n  \n  editEvent(ME.DATA.event.id);\n  $(ME).find('.selectedevent').change(function(){\n    var d = $('#event_edit')[0].data;\n    d.event = $(ME).find('.selectedevent').val();\n  });\n};\n\nfunction selectApp(val){\n  json('../botmanager/events', 'id='+val, function(result){\n    if (result.list){\n      var d = $('#event_edit')[0].data;\n      var newhtml = \"<select class='eventpicker'>\";\n      for (var i in result.list){\n        var name = result.list[i];\n        var issel = d.event == name ? \" selected\" : \"\";\n        newhtml += \"<option value='\"+name+\"'\"+issel+\">\"+name+\"<\/option>\";\n      }\n      newhtml += \"<\/select>\";\n      $(ME).find('.eventselect').html(newhtml);\n      var newval = $(ME).find('.eventpicker').val();\n      if (val != d.bot){\n        $(ME).find('.selectedevent').val(newval);\n        d.bot = val;\n        d.event = newval;\n      }\n      $(ME).find('.eventpicker').change(function(){\n        var newval = $(ME).find('.eventpicker').val();\n        $(ME).find('.selectedevent').val(newval);\n        d.event = newval;\n      });\n    }\n  });\n}\n\nfunction editEvent(id, cb){\n  $('#event_edit_msg').html('');\n  var data = ME.DATA.event;\n  $('.event_edit_name').text(data.name);\n  $('#event_edit')[0].uuid = id;\n  json('../botmanager/read', 'db='+ME.DATA.db+'&id='+encodeURIComponent(id), function(result){\n    if (result.status != 'ok') error(result.msg, 'event_edit_msg');\n    else {\n      var d = result.data;\n      $('#event_edit')[0].data = d;\n      if (d.cmd) $('#event_edit_task').val(d.cmd);\n      if (!d.bot) {\n        d.bot = \"botmanager\";\n        d.event = \"write\"\n      }\n      $(ME).find('.selectedevent').val(d.event);\n      \n      var dd = {\n        \"label\": \"On Event:\",\n        \"value\": d.bot,\n        \"cb\": selectApp\n      };\n      var el = $(ME).find('.eventappselect')[0];\n      installControl(el, \"metabot\", \"appselect\", function(api){\n        selectApp(d.bot);\n      }, dd);\n      \n      if (cb) cb();\n    }\n  });\n}\n\nfunction deleteEvent(){\n  var uuid = $('#event_edit')[0].uuid;\n  if (confirm('Are you sure you want to delete this event? This cannot be undone.')) json('../botmanager/event', 'mode=kill&id='+encodeURIComponent(uuid), function(result){\n    if (result.status != 'ok') alert(result.msg);\n    else \n      json('../botmanager/delete', 'db='+ME.DATA.db+'&id='+encodeURIComponent(uuid), function(result){\n      var d = getByProperty(ME.DATA.ctlapi.CTLDATA.event, 'id', uuid);\n      var i = ME.DATA.ctlapi.CTLDATA.event.indexOf(d);\n      ME.DATA.ctlapi.CTLDATA.event.splice(i,1);\n      ME.DATA.ctlapi.saveControl();\n      ME.DATA.ctlapi.buildEventList();\n      closeEvent();\n    });\n  });\n}\n$('#deletetheeventbutton').click(deleteEvent);\n\nfunction closeEvent(){\n  $('.api-main').css('display', 'block');\n  $('.api-editevent').css('display', 'none');\n}\n$('#canceltheeventbutton').click(closeEvent);\n\n\nfunction saveEvent(){\n  var DB = ME.DATA.db;\n  var data = $('#event_edit')[0].data;\n  var uuid = $('#event_edit')[0].uuid;\n  data.cmd = $('#event_edit_task').val();\n  data.cmddb = DB;\n\n  json('../botmanager/event', 'mode=set&params='+encodeURIComponent(JSON.stringify(data))+'&id='+encodeURIComponent(uuid), function(result){\n    if (result.status != 'ok') alert(result.msg);\n    else \n      json('../botmanager/write', 'db='+DB+'&data='+encodeURIComponent(JSON.stringify(data))+'&id='+encodeURIComponent(uuid), function(result){\n      if (result.status != 'ok') alert(result.msg);\n      else $('#canceltheeventbutton').click();\n    });\n  });\n}\n$('#savetheeventbutton').click(saveEvent);\n","groups":"","ctl":"wytxhx174450587d2i6b3","html":"<div id='event_edit' class='padmex'>\n  <h1>Edit Event Behavior<\/h1>\n  <h2 id='event_edit_name' class='event_edit_name'><\/h2>\n  <div class='eventappselect'><\/div>\n  <div class='selecteventname'>\n    <span class='eventselect'><\/span>\n    <input type='text' class='selectedevent'>\n  <\/div>\n  <div>\n      <label for='event_edit_task'>Fire Command:<\/label>\n      <select id='event_edit_task' class='cmdselect'><\/select>\n  <\/div>\n  <br>\n  <div id='event_edit_msg'><\/div>\n  <br><br>\n  <button class='bggreen butpad' id='savetheeventbutton'>save<\/button>\n  <button class='bggray butpad' id='canceltheeventbutton'>cancel<\/button>\n  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n  <button class='bgwhite butpad' id='deletetheeventbutton'>delete<\/button>\n<\/div>","three":{"controls":[]},"db":"metabot","desc":""},"id":"wytxhx174450587d2i6b3","sessionid":"jvgvwg16b7a4d277bt3","time":1598970104459,"addr":"/0:0:0:0:0:0:0:1:48428","username":"admin"}