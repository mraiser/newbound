{"data":{"attachmentkeynames":["html","css","js"],"ctl":"hourqo178db82dd4bl20","data":[],"db":"flow","desc":"","groups":"anonymous","name":"operation","three":{"animations":[],"assets":[],"behaviors":[{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.data = ME.DATA;\nme.model = model;\nme.type = \"operation\";\nme.box = me.children[0];\nme.text = me.children[1];\nme.inputbar = me.children[2];\nme.outputbar = me.children[3];\n\nme.inputbar.api.minw = 0.5;\nme.inputbar.api.updateWidth();\nme.outputbar.api.minw = 0.5;\nme.outputbar.api.updateWidth();\n\nme.inputbar.api.parent = me;\nme.inputbar.api.immobile = true;\nme.inputbar.api.direction = \"dst\";\nme.outputbar.api.parent = me;\nme.outputbar.api.immobile = true;\nme.outputbar.api.direction = \"src\";\n\nif (!ME.DATA.name) me.setLabel(\"UNTITLED\");\nelse me.setLabel(ME.DATA.name);\n\nif (!ME.DATA.type) ME.DATA.type = \"local\";\nme.setShape(ME.DATA.type);\nvar cb = ME.DATA.onready; // FIXME - kind of a hack\nif (ME.DATA.onready) delete ME.DATA.onready;\nme.setNodes(ME.DATA, cb);\n","id":"3185df0c-4c27-4cc3-9d56-9ad0c64ebf05","name":"animate","params":[{"name":"model","type":"object"}]},{"body":"var me = this;\nme.inputbar.api.target_z = me.target_z;\nme.outputbar.api.target_z = me.target_z;\nme.inputbar.api.target_rot = me.target_rot;\nme.outputbar.api.target_rot = me.target_rot;\n\nme.inputbar.api.updateLines();\nme.outputbar.api.updateLines();\n","id":"30d6cbb7-172c-43bc-8717-1adf66030242","name":"render","params":[{"name":"model","type":"object"}]},{"body":"var me = this;\nme.parent.dirty();\n","id":"e3df3699-d883-4f00-93cf-f008fc18e278","name":"dirty","params":[]},{"body":"var me = this;\nvar cmd = {};\ncmd.name = me.data.name;\ncmd.type = me.data.type;\ncmd.in = me.inputbar.api.getCode();\ncmd.out = me.outputbar.api.getCode();\ncmd.width = me.box.rig.scale_x;\ncmd.pos = new THREE.Vector3(me.model.rig.pos_x, me.model.rig.pos_y, me.model.rig.pos_z);\nif (me.data.condition) cmd.condition = me.data.condition;\nif (cmd.type == 'constant' || cmd.type == 'match') cmd.ctype = me.data.ctype;\nelse if (cmd.type == 'command') cmd.cmd = me.data.cmd;\nelse if (cmd.type == 'local') {\n  if (me.localdata) cmd.localdata = me.localdata.getCode();\n  else cmd.localdata = me.data.localdata;\n}\nreturn cmd;\n","id":"9b454c67-5f09-4f65-bc00-95569fe71fda","name":"getCode","params":[]},{"body":"var me = this;\nif (type == 'constant') {\n  me.inputbar.api.box.api.data.opacity = 0;\n  me.outputbar.api.box.api.data.opacity = 1;\n  me.box.api.data.opacity = 0;\n  me.data.condition = null;\n}\nelse if (type == 'match') {\n  me.inputbar.api.box.api.data.opacity = 1;\n  me.outputbar.api.box.api.data.opacity = 0;\n  me.box.api.data.color = \"black\";\n  me.box.api.data.opacity = 0;\n  if (!me.data.condition) me.data.condition = {\n    \"value\": true,\n    \"rule\": \"next\"\n  };\n}\nelse {\n  me.box.api.data.opacity = 1;\n  \n  if (me.inputbar.api.box)\n    me.inputbar.api.box.api.data.opacity = 1;\n  if (me.outputbar.api.box)\n    me.outputbar.api.box.api.data.opacity = 1;\n\n  if (type == \"primitive\") me.box.api.data.color = 0x333333;\n  else if (type == \"command\") me.box.api.data.color = 0xAAAAAA;\n  else if (type == \"function\") me.box.api.data.color = 0x777777;\n  else if (type == \"persistent\") me.box.api.data.color = 0xfcba03;\n  else me.box.api.data.color = 0xFFFFFF;\n}\n\n//me.box.api.data.shape=\"stl\";\n//me.box.api.data.filename=\"flow:getter.stl\";\n\nme.box.api.rebuild();\nif (me.inputbar.api.box) me.inputbar.api.box.api.rebuild();\nif (me.outputbar.api.box) me.outputbar.api.box.api.rebuild();\nme.checkIcon();\nme.updateWidth();\n","id":"c78463fa-6642-423b-a3d6-f85e519b6add","name":"setShape","params":[{"name":"type","type":"object"}]},{"body":"var me = this;\nif (!me.data.condition) me.clearIcon();\nelse if (!me.icon) me.addIcon();\nelse me.icon.update(me.data.condition);\n","id":"214172af-d928-4646-a142-f8d406383209","name":"checkIcon","params":[]},{"body":"var me = this;\nif (me.icon) me.model.scene.viewer.removeModel(me.icon);\nme.icon = null;\n","id":"270d0d2a-31d1-4cb9-b0ba-1d60953e19fe","name":"clearIcon","params":[]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nvar el = $('<div/>'); // FIXME - never removed, same as in node\n$(ME).append(el);\nvar ctl = {};\nvar s = 0.1;\nctl.scale = new THREE.Vector3(s, s, s);\nvar bounds = me.text.models[0].geometry.boundingBox;\nvar x = bounds.max.x * me.text.rig.scale_x * 0.5 + 0.5;\nctl.pos = new THREE.Vector3(x, 0, 0);\nctl.condition = me.data.condition;\nme.model.scene.viewer.add(el[0], \"flow\", \"conditionalicon\", function(model){\n  me.icon = model.api;\n  model.api.parent = me;\n}, ctl, me.model.group);\n","id":"cd353e7f-f9c9-4535-8754-0e8e8908c30a","name":"addIcon","params":[]},{"body":"var me = this;\nvar count = 0;\nvar cb2 = function(){\n  if (++count == 2 && cb) cb();\n};\n\nif (data.in) me.inputbar.api.setNodes(data.in, cb2);\nelse cb2();\nif (data.out) me.outputbar.api.setNodes(data.out, cb2);\nelse cb2();\n","id":"c9bd3f47-18d8-4d8c-a7bd-069baf834873","name":"setNodes","params":[{"name":"data","type":"object"},{"name":"cb","type":"object"}]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nME.DATA.name = label;\nme.text.api.data.text = ME.DATA.name;\nme.text.api.rebuild();\n//me.text.models = me.text.children; // FIXME - HACK\nif (me.text.children[0]) {\n  me.text.children[0].geometry.computeBoundingBox();\n  var bounds = me.text.children[0].geometry.boundingBox;\n  var w = bounds.max.x - bounds.min.x;\n  me.text.rig.pos_x = (0 - (w/2)) * me.text.rig.scale_x;\n}\nme.updateWidth();\n","id":"41a71555-ea7b-431b-97fe-f2fdf12b03a0","name":"setLabel","params":[{"name":"label","type":"object"}]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nvar list = me.inputbar.api.nodes.slice();\nfor (var i in list) list[i].delete();\nlist = me.outputbar.api.nodes.slice();\nfor (var i in list) list[i].delete();\nvar i = me.parent.cmds.indexOf(me);\nif (i != -1) me.parent.cmds.splice(i, 1);\nme.model.scene.viewer.removeModel(me.box);\nme.model.scene.viewer.removeModel(me.text);\nme.model.scene.viewer.removeModel(me.inputbar);\nme.model.scene.viewer.removeModel(me.outputbar);\nme.model.scene.viewer.removeModel(me);\nme.dirty();\n$(ME).remove();\n","id":"55792ad6-b144-46f5-8800-46a2d7dd9260","name":"delete","params":[]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nif (me.text.children[0]) {\n  var bounds = me.text.children[0].geometry.boundingBox;\n  var minx = Math.min(me.inputbar.api.minx - 0.5, me.outputbar.api.minx - 0.5, bounds.min.x * me.text.rig.scale_x + me.text.rig.pos_x - 0.125);\n  var maxx = Math.max(me.inputbar.api.maxx + 0.5, me.outputbar.api.maxx + 0.5, bounds.max.x * me.text.rig.scale_x + me.text.rig.pos_x + 0.125);\n  var w = maxx - minx;\n  me.box.rig.scale_x = w;\n  me.box.rig.pos_x = w/2 + minx;\n  if (me.icon) {\n    var x = ME.DATA.type == \"match\" ? bounds.max.x * me.text.rig.scale_x * 0.5 + 0.5 : w/2 + 0.5;\n    me.icon.model.rig.pos_x = x;\n  }\n}","id":"3866b88b-c4df-4063-824a-b8b2488683d2","name":"updateWidth","params":[]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\n$('#'+me.parent.parent.UUID).find(\".closecasebutton\").css('display', 'block');\n$('#'+me.parent.parent.parent.UUID).find(\".closecasebutton\").css('display', 'block'); // FIXME - bit of a hack\nme.inputbar.api.select();\nme.outputbar.api.select();\nif (!me.editor) {\n  me.editor = $(\"<div class='floweditor' />\");\n  $(ME).append(me.editor);\n  installControl(me.editor[0], \"flow\", \"operation_editor\", function(api){\n    api.parent = me;\n  }, ME.DATA);\n}\nme.editor.css(\"display\", \"block\");\n","id":"84f23a3f-0f84-45a6-a809-a58ed307c5b2","name":"select","params":[]},{"body":"var me = this;\nme.inputbar.api.unselect();\nme.outputbar.api.unselect();\nif (me.editor){\n  me.editor.remove();\n  me.editor = null;\n}\n","id":"7a0ca0bc-8fb2-498e-b18e-c3c7835f3ae8","name":"unselect","params":[]},{"body":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nif (me.data.type == 'local'){\n  me.unselect();\n  $('.casebuttons').css('display', 'none');\n\n  var casedata = me.data.localdata = me.data.localdata ? me.data.localdata : {cmds:[], cons:[], input:{}, output:{}};\n  casedata.pos = new THREE.Vector3(0,0,-20);\n  casedata.input = me.inputbar.api.getCode();\n  casedata.output = me.outputbar.api.getCode();\n  var el = $('<div/>');\n  $(ME).append(el);\n  me.model.scene.viewer.add(el[0], \"flow\", \"case\", function(model){\n    me.parent.target_z = 20;\n\n    //var nodes = {};\n    //nodes.in = me.inputbar.api.getCode();\n    //nodes.out = me.outputbar.api.getCode();\n    //model.api.setNodes(nodes);\n\n    me.localdata = model.api;\n    me.localdata.parent = me;\n    me.localdata.target_z = 0;\n\n    $(\".closecasebutton\").css('display', 'none');\n    var el2 = '<div class=\"toprightcorner\"><button class=\"closecasebutton mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored\"><i class=\"material-icons\">arrow_circle_up</i></button></div>';\n    $(ME).append(el2);\n    $(ME).find(\".closecasebutton\").click(function(){\n      var oldcase = me.localdata;\n      me.localdata = null;\n      oldcase.currentcase.target_z = -20;\n\n      me.parent.target_z = 0;\n      me.parent.select(me);\n      me.data.localdata = oldcase.getCode();\n      $(ME).find(\".closecasebutton\").parent().remove();\n      el.remove();\n      $('#'+me.parent.UUID).find('.casebuttons').css('display', 'block');\n\n      var nodes = {};\n      nodes.in = oldcase.inputbar.api.getCode();\n      nodes.out = oldcase.outputbar.api.getCode();\n      me.setNodes(nodes);\n\n      setTimeout(function(){\n        for (var i in oldcase.cases) me.removeModels(oldcase.cases[i]);\n        me.parent.rebuildCaseButtons();\n      }, 500);\n    });\n  }, casedata);\n}\n","id":"cf746ce3-ef8e-402d-8c5d-55b433e03cde","name":"dblclick","params":[{"name":"event","type":"object"}]},{"body":"var me = this;\nme.model.scene.viewer.removeModel(oldcase);\noldcase.select(null);\nfor (var i in oldcase.outputbar.api.nodes) {\n  var node = oldcase.outputbar.api.nodes[i];\n  if (node.line) node.model.scene.remove(node.line);\n}\nfor (var j in oldcase.cmds) {\n  var cmd = oldcase.cmds[j];\n  for (var i in cmd.inputbar.api.nodes) {\n    var node = cmd.inputbar.api.nodes[i];\n    if (node.line) node.model.scene.remove(node.line);\n  }\n}\n","id":"f46fb164-3de0-4f5c-a5d4-5bebb44de857","name":"removeModels","params":[{"name":"oldcase","type":"object"}]},{"body":"var me = this;\nvar p = me.parent;\nwhile (p.type != 'case') p = p.parent;\np.select(me);\nevent.handled = true;\nreturn false;\n","id":"37da105c-85a9-4875-ab42-7b7d263071fb","name":"click","params":[{"name":"event","type":"object"}]},{"body":"var me = this;\nvar pos = me.model.scene.viewer.to3D(event.clientX, event.clientY);\nme.model.rig.pos_x = pos.x;\nme.model.rig.pos_y = pos.y;\nme.model.rig.pos_z = pos.z;\nme.inputbar.api.updateLines();\nme.outputbar.api.updateLines();\nme.dirty();\n","id":"b9723b6d-394c-4e24-8354-7aeac5512db9","name":"drag","params":[{"name":"event","type":"object"}]}],"controls":[{"color":"0xffff00","db":"app","id":"thjigj18acf15b42an59c","name":"box","pos":{"x":0,"y":0,"z":0},"rot":{"x":0,"y":0,"z":0},"scale":{"x":"1.5","y":"0.5","z":"0.5"},"uuid":"b1023813-6a3a-45e3-84c4-a9e4ad05147b"},{"color":"#00ff00","db":"app","id":"thjigj18acf15b42an59c","name":"label","pos":{"x":"-0.6","y":"-0.2","z":"0.25"},"rot":{"x":0,"y":0,"z":0},"scale":{"x":"0.005","y":"0.005","z":"0.005"},"shape":"text","text":"  ","uuid":"691b928e-0f82-422a-9059-834b23e6293d"},{"db":"flow","id":"ownorw178d6b6e9d8j1f","name":"inputbar","nodes":[],"pos":{"x":"0","y":"0.3","z":"0"},"rot":{"x":0,"y":0,"z":0},"scale":{"x":1,"y":1,"z":1},"uuid":"855829db-d819-41b9-af17-5d6cc4940e48"},{"db":"flow","id":"ownorw178d6b6e9d8j1f","name":"outputbar","nodes":[],"pos":{"x":"0","y":"-0.3","z":"0"},"rot":{"x":0,"y":0,"z":0},"scale":{"x":1,"y":1,"z":1},"uuid":"d2c065f7-657e-4254-bfdb-dfe311baa185"}],"poses":[]}},"id":"hourqo178db82dd4bl20","readers":["anonymous"],"time":1703447751885,"username":"system","writers":[]}