{"data":{"css":".flowcodeviewer {\n  position:absolute;\n  top:0px;\n  left:0px;\n  right:0px;\n  height:100%;\n  background-color:black;\n}\n\n.floweditor {\n  position:absolute;\n  background-color:white;\n  padding: 20px;\n  width:auto;\n  height:auto;\n  color: rgba(0,0,0,.87);\n}\n\n.floweditor .mdl-selectfield__select{\n  color: rgba(0,0,0,.87);\n}\n\n.toprightcorner {\n  position:absolute;\n  top:0px;\n  right:0px;\n}","data":[],"name":"editor","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(api){\n  componentHandler.upgradeAllRegistered();\n\n  var el = $(ME).find('.flowcodeviewer');\n  el.data('orbitcontrols', false);\n  el.data('showdatgui', false);\n  \n  installControl(el[0], 'threejs', 'viewer', function(api){\n    me.viewer = api;\n    api.waitReady(function(){\n//      me.data = ME.DATA;\n//      if (!me.data) me.data = {};\n      \n      var scene = me.viewer.scene;\n      var camera = scene.camera;\n      \n      camera.position.x = 0;\n      camera.position.y = 0;\n      camera.position.z = 10;    \n      camera.lookAt(scene.position);\n\n      if (!ME.DATA.input) {\n        $(ME).find(\".savebutton\").css(\"display\", \"block\");\n        json('../botmanager/read', 'db=code&id=src', function(result){               var ctl = result.data;\n          me.setData(ctl);\n        });\n      }\n      else me.setData(ME.DATA);\n    });\n  }, {});\n};\n\nme.dirty = function(){\n  if (me.parent && me.parent.dirty) me.parent.dirty();\n};\n\nme.getData = function(){\n  return me.case.getCode();\n};\n\n$(ME).find(\".closecasebutton\").click(function(e){\n  me.case.target_z = -20;\n  var oldcase = me.case;\n  me.case = me.cases.pop();\n  me.case.target_z = 0;\n  me.case.select(me.case.selected);\n  me.case.selected.data.localdata = oldcase.getCode();\n  $(ME).find(\".closecasebutton\").css(\"display\", me.cases.length > 0 ? \"block\" : \"none\");\n  \n  var nodes = {};\n  nodes.in = oldcase.inputbar.api.getCode();\n  nodes.out = oldcase.outputbar.api.getCode();\n  me.case.selected.setNodes(nodes);\n  \n  setTimeout(function(){\n    oldcase.model.group.parent.remove(oldcase.model.group);\n    oldcase.select(null);\n    for (var i in oldcase.outputbar.api.nodes) {\n      var node = oldcase.outputbar.api.nodes[i];\n      if (node.line) node.model.scene.remove(node.line);\n    }\n    for (var j in oldcase.cmds) {\n      var cmd = oldcase.cmds[j];\n      for (var i in cmd.inputbar.api.nodes) {\n        var node = cmd.inputbar.api.nodes[i];\n        if (node.line) node.model.scene.remove(node.line);\n      }\n    }\n  }, 500);\n});\n\nme.editCase = function(casedata, cb){\n  casedata.pos = new THREE.Vector3(0,0,-20);\n  var el = $('<div/>');\n  $(ME).append(el);\n  me.viewer.add(el[0], \"flow\", \"case\", function(model){\n    me.case.target_z = 20;\n    \n    var nodes = {};\n    nodes.in = me.case.selected.inputbar.api.getCode();\n    nodes.out = me.case.selected.outputbar.api.getCode();\n    model.api.setNodes(nodes);\n    \n    me.cases.push(me.case);\n    me.case = model.api;\n    me.case.parent = me;\n    me.case.target_z = 0;\n    $(ME).find(\".closecasebutton\").css(\"display\", \"block\");\n    if (cb) cb(model.api)\n  }, casedata);\n};\n\nme.setData = function(ctl){\n  var el = $('<div/>');\n  $(ME).append(el);\n  me.viewer.add(el[0], \"flow\", \"case\", function(model){\n    me.case = model.api;\n    me.case.parent = me;\n    me.case.target_z = 0;\n    me.cases = [];\n    $(ME).find('canvas').prop('tabindex', 0).keydown(function(e){\n      if (e.keyCode == 46) me.case.deleteSelected();\n      console.log(e);\n    });\n  }, ctl);\n};\n      \n$(ME).click(function(e){\n  console.log(\"------------------------------------\");\n  console.log(e);\n  console.log(\"------------------------------------\");\n  \n  if (e.shiftKey){\n    console.log(\"SHIFT\");\n  }\n});\n\n$(ME).find(\".savebutton\").click(function(e){\n  var code = me.case.getCode();\n  console.log(code);\n  json('../botmanager/write', 'db=code&id=src&data='+encodeURIComponent(JSON.stringify(code)), function(result){});\n  \n  return false;\n});\n\n\n\n\n\n\n","groups":"anonymous","ctl":"yrirzr178dfe7bd62m18","html":"<div class='flowcodeviewer'><\/div>\n<div class=\"toprightcorner\">\n  <button class=\"savebutton\" style=\"display:none;\">save<\/button>\n  <button class=\"closecasebutton mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored\" style=\"display:none;\">\n\n    <i class=\"material-icons\">arrow_circle_up<\/i>\n  <\/button>\n<\/div>","three":{"controls":[]},"db":"flow","desc":""},"readers":["anonymous"],"id":"yrirzr178dfe7bd62m18","sessionid":"jvgvwg16b7a4d277bt3","time":1619717822018,"addr":"/0:0:0:0:0:0:0:1:53492","username":"admin"}