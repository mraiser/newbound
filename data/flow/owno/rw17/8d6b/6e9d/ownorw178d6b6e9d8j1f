{"data":{"css":"","data":[],"name":"inputbar","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.animate = function(model){\n  me.model = model;\n  me.type = \"putbar\";\n  me.box = me.children[0];\n  if (!me.nodes) me.nodes = [];\n  if (!me.minw) me.minw = 0.5;\n  me.updateWidth();\n};\n\nme.render = function(model){\n  for (var i in me.nodes) {\n    me.nodes[i].target_z = me.target_z;\n    me.nodes[i].target_rot = me.target_rot;\n  }\n};\n\nme.dirty = function(){\n  me.parent.dirty();\n};\n\nme.getCode = function(){\n  var o = {};\n  for (var j=0; j<me.nodes.length; j++){\n    var n = me.nodes[j];\n    if (!n.data.mode) n.data.mode = \"regular\";\n    o[n.data.name] = {\n      \"x\": n.model.rig.pos_x,\n      \"type\": n.data.type,\n      \"mode\": n.data.mode\n    };\n  }\n  return o;\n};\n\nfunction spaceNodes(){\n  var c = me.nodes.length;\n  var w = Math.max(me.box.rig.scale_x - 0.5, 0.25 * (c-1) + 0.5);\n  var d = c == 1 ? 0 : Math.max(0.25, w / (c-1));\n  var o = c == 1 ? 0 : w / -2;\n  for (var i=0; i<c; i++){\n    var node = me.nodes[i];\n    node.model.rig.pos_x = i * d + o;\n  }\n  me.updateWidth();\n}\n\nme.setNodes = function(data, cb){\n  var list = [];\n  for (var name in data) list.push(name);\n  if (me.nodes.length<list.length) me.addNode({\"name\": \"xxx\", \"type\": \"object\", \"mode\": \"regular\"}, new THREE.Vector3(0,0,0), function(api){\n    spaceNodes();\n    me.setNodes(data, cb);\n  });\n  else {\n    while (me.nodes.length>list.length){\n      me.nodes[me.nodes.length-1].delete();\n    }\n    for (var i=0; i<me.nodes.length; i++)\n    {\n      var node = me.nodes[i];\n      var d = data[list[i]];\n      if (d.x) node.model.rig.pos_x = d.x;\n      node.data.name = list[i];\n      if (d.type) node.data.type = d.type;\n      if (d.mode) node.data.mode = d.mode;\n      if (node.editor){\n        node.editor.find(\".node_name\").val(list[i]);\n        node.editor.find(\".node_type_div\")[0].api.val(node.data.type);\n        node.editor.find(\".node_mode_div\")[0].api.val(node.data.mode);\n      }\n      node.checkIcon();\n    }\n    me.updateWidth();\n    if (cb) cb();\n  }\n};\n\nme.updateWidth = function(){\n  var minhalf = me.minw/2;\n  var minx = -minhalf;\n  var maxx = minhalf;\n  for (var i=0; i<me.nodes.length; i++){\n    if (Number(me.nodes[i].model.rig.pos_x)<minx) minx = Number(me.nodes[i].model.rig.pos_x);\n    if (Number(me.nodes[i].model.rig.pos_x)>maxx) maxx = Number(me.nodes[i].model.rig.pos_x);\n  }\n  me.minx = Math.min(0-(minhalf), minx);\n  me.maxx = Math.max(me.minw/2, maxx);\n\n  var w = Math.max(me.minw, me.maxx - me.minx + 0.5);\n  me.box.rig.scale_x = w;\n  me.box.rig.pos_x = w/2 + me.minx - 0.25;\n  \n  if (me.parent && me.parent.updateWidth) me.parent.updateWidth();\n}\n\nme.select = function() {\n  me.box.api.data.color = 0x0000ff;\n  me.box.api.rebuild();\n}\n\nme.unselect = function() {\n  me.box.api.data.color = 0xffffff;\n  me.box.api.rebuild();\n}\n\n// FIXME - Adjust by click offset from centeer\nme.drag = function(event, x, y){\n  if (!me.immobile){\n    var pos = me.model.scene.viewer.to3D(event.clientX, event.clientY);\n    me.model.rig.pos_x = pos.x;\n    me.model.rig.pos_y = pos.y;\n    me.model.rig.pos_z = pos.z;\n    me.updateLines();\n  }\n};\n\nme.updateLines = function(){\n  for (var i in me.nodes) me.nodes[i].updateLines();\n}\n\nfunction getNodeByName(name){\n  for (var i in me.nodes) if (me.nodes[i].data.name == name) return me.nodes[i];\n  return null;\n}\nme.getNodeByName = getNodeByName;\n\nfunction nextNodeName(){\n  var i = 0;\n  while (i<26) { // FIXME\n    var res = String.fromCharCode(97+i++);\n    if (!getNodeByName(res)) return res;\n  }\n  return \"a\"+newDate().getTime();\n}\n\nme.addNode = function(ctl, pos, cb){\n  var el = $('<div/>');\n  $(ME).append(el);\n  me.model.scene.viewer.add(el[0], \"flow\", \"node\", function(model){\n    me.children.push(model);\n    me.nodes.push(model.api);\n    model.api.parent = me;\n    model.parent = me;\n    model.api.direction = me.direction;\n    model.rig.pos_x = pos.x;\n    if (cb) cb(model.api);\n  }, ctl, me.model.group);\n};\n\nme.click = function(e){\n  if (!e.handled){\n    e.handled = true;\n    if (e.shiftKey) {\n      var pos = me.model.scene.viewer.to3D(e.clientX, e.clientY);\n      var m = me;\n      while (m && m.model && m.model.rig){\n        pos.x -= m.model.rig.pos_x;\n        m = m.parent;\n        if (m.type == 'case') break;\n      }\n      var ctl = {\n      \t\"name\": nextNodeName(),\n        \"type\": \"object\"\n      };\n      me.addNode(ctl, pos);\n    }\n    else {\n      var p = me.parent;\n      while (p.type != 'case') p = p.parent;\n      p.select(me);\n    }\n  }\n  return false;\n}\n","groups":"anonymous","ctl":"ownorw178d6b6e9d8j1f","html":"","three":{"controls":[{"color":"0xffff00","pos":{"x":"0","y":"0","z":"0"},"rot":{"x":"0","y":"0","z":"0"},"name":"outerbox","scale":{"x":"1","y":"0.2","z":"0.2"},"id":"hmzspn1682ebb4187udc6e","uuid":"be2c7e00-1d8f-4da0-a19b-803236bca81a","db":"threejs"}]},"db":"flow","desc":""},"readers":["anonymous"],"id":"ownorw178d6b6e9d8j1f","sessionid":"jvgvwg16b7a4d277bt3","time":1621536703548,"addr":"/0:0:0:0:0:0:0:1:38802","username":"admin"}